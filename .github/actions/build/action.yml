name: 'Build'
description: 'Build MetGem and returns produced asset name and mimetype'
outputs:
  asset-name: 
    description: "Name of produced asset"
    value: ${{ steps.build.outputs.asset-name }}
  asset-mimetype:
    description: "MimeType of produced asset"
    value: ${{ steps.build.outputs.asset-mimetype }}
  asset-ext:
    description: "Extension of produced asset"
    value: ${{ steps.build.outputs.asset-ext }}
  asset-basename:
    description: "Name of produced asset without extension"
    value: ${{ steps.build.outputs.asset-basename }}
runs:
  using: "composite"
  steps:
    - name: Build
      shell: bash -l {0}
      id: build
      run: |
        git submodule foreach "git fetch --tags -f"
        python metgem/setup.py version
        python -m invoke build
        shopt -s extglob
        asset_name=`find . -maxdepth 1 \( -name "setup_MetGem*" -or -name "MetGem*.dmg" -or -name "MetGem*.AppImage" \) -print0 | xargs -0 ls -t | head -n 1 | xargs -n 1 basename`
        echo "asset-name=$asset_name" >> $GITHUB_OUTPUT
        echo "asset-mimetype=`file -b --mime-type $asset_name`" >> $GITHUB_OUTPUT
        echo "asset-ext=${asset_name#*.}" >> $GITHUB_OUTPUT
        echo "asset-basename=${asset_name%.*}" >> $GITHUB_OUTPUT
